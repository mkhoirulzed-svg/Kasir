<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kasir Toko Alkes</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { background: #f6f6f6; }
  </style>
</head>

<body class="p-6">

  <h1 class="text-2xl font-bold mb-4">KASIR TOKO ALKES</h1>

  <!-- INPUT FORM -->
  <div class="bg-white p-4 shadow rounded-lg mb-6">
    <label class="block mb-2 font-semibold">Nama Barang</label>
    <input id="namaBarang" class="border rounded w-full p-2 mb-3" placeholder="contoh: Spuit 3 ml" />

    <label class="block mb-2 font-semibold">Harga</label>
    <input id="harga" type="number" class="border rounded w-full p-2 mb-3" placeholder="contoh: 1500" />

    <label class="block mb-2 font-semibold">Qty</label>
    <input id="qty" type="number" class="border rounded w-full p-2 mb-3" placeholder="contoh: 2" />

    <button onclick="tambahItem()" class="bg-blue-600 text-white px-4 py-2 rounded">
      Tambah ke Struk
    </button>
  </div>

  <!-- TABEL PESANAN -->
  <div class="bg-white p-4 shadow rounded-lg mb-6">
    <h2 class="text-xl font-bold mb-3">Daftar Belanja</h2>

    <table class="w-full border">
      <thead>
        <tr class="bg-gray-200">
          <th class="border p-2">Barang</th>
          <th class="border p-2">Harga</th>
          <th class="border p-2">Qty</th>
          <th class="border p-2">Subtotal</th>
        </tr>
      </thead>
      <tbody id="daftarBelanja"></tbody>
    </table>

    <h3 class="text-right text-xl font-bold mt-4">Total: Rp <span id="totalHarga">0</span></h3>

    <button onclick="simpanTransaksi()" class="bg-green-600 text-white w-full py-3 rounded mt-4">
      Simpan Transaksi + Update Stok
    </button>
  </div>

  <!-- STRUK -->
  <div class="bg-white p-4 shadow rounded-lg" id="struk" style="display:none;">
    <h2 class="text-xl font-bold mb-3">Struk Transaksi</h2>
    <div id="strukIsi"></div>
  </div>


<script>
  let items = [];

  function tambahItem() {
    const nama = document.getElementById("namaBarang").value.trim();
    const harga = parseInt(document.getElementById("harga").value);
    const qty = parseInt(document.getElementById("qty").value);

    if (!nama || !harga || !qty) {
      alert("Semua input harus diisi!");
      return;
    }

    items.push({ nama, harga, qty });

    renderTabel();
  }

  function renderTabel() {
    const tbody = document.getElementById("daftarBelanja");
    tbody.innerHTML = "";

    let total = 0;

    items.forEach((item, i) => {
      total += item.harga * item.qty;

      tbody.innerHTML += `
        <tr>
          <td class="border p-2">${item.nama}</td>
          <td class="border p-2">Rp ${item.harga}</td>
          <td class="border p-2">${item.qty}</td>
          <td class="border p-2">Rp ${item.harga * item.qty}</td>
        </tr>
      `;
    });

    document.getElementById("totalHarga").innerText = total;
  }

  // =====================
  //  UPDATE STOK GOOGLE SHEETS
  // =====================
  async function updateStokKeSheets(item) {
    return fetch("https://script.google.com/macros/s/AKfycbwJM4vHIfuMNS8iURwWSC1zODcI1bjytTPD2LovUl_FWe4FmNtgM-4PC7F0jNnTUxopIg/exec", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        sheet: "Stok_Toko_Alkes",
        barang: item.nama,
        qty: item.qty
      })
    })
    .then(res => res.json())
    .catch(err => ({ status: "ERROR", message: err }));
  }

  // =====================
  //  SIMPAN TRANSAKSI
  // =====================
  async function simpanTransaksi() {
    if (items.length === 0) {
      alert("Belum ada item!");
      return;
    }

    // Update stok untuk setiap item (LOGIKA B)
    for (let item of items) {
      let res = await updateStokKeSheets(item);
      console.log("Update stok:", item.nama, res);
    }

    // Tampilkan struk
    tampilkanStruk();

    alert("Transaksi disimpan & stok sudah diperbarui!");
    items = [];
    renderTabel();
  }

  function tampilkanStruk() {
    const div = document.getElementById("strukIsi");
    div.innerHTML = "";

    items.forEach(item => {
      div.innerHTML += `
        <p>${item.nama} (${item.qty} x Rp ${item.harga}) = Rp ${item.harga * item.qty}</p>
      `;
    });

    document.getElementById("struk").style.display = "block";
  }
</script>

</body>
</html>
