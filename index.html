<!DOCTYPE html>
<html lang="id">
<head>
<!-- ===== PWA & ICON ===== -->
<link rel="icon" type="image/png" href="logo.png">
<link rel="apple-touch-icon" href="logo.png">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1a56db">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kasir Alkes PKY</title>

<!-- ===== LIBRARY ===== -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap">

<style>
body {
    margin:0;
    font-family:'Inter',sans-serif;
    background:#e9f2ff;
    padding:15px;
}
h2 {
    text-align:center;
    color:#1a56db;
}
.header {
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    margin-bottom:10px;
}
.header img {
    height:40px;
}
.card {
    background:#fff;
    padding:15px;
    border-radius:12px;
    box-shadow:0 3px 10px rgba(0,0,0,.1);
    margin-bottom:20px;
}
input,select {
    width:100%;
    padding:12px;
    margin:6px 0;
    border-radius:8px;
    border:1px solid #ccc;
    font-size:16px;
}
.btn {
    width:100%;
    padding:14px;
    border:none;
    border-radius:8px;
    font-size:18px;
    font-weight:bold;
    margin-top:10px;
    background:#1a56db;
    color:#fff;
    cursor:pointer;
}
table {
    width:100%;
    font-size:15px;
}
td { padding:6px 0; }
.right { text-align:right; }
.total-box {
    text-align:right;
    font-size:20px;
    font-weight:bold;
    color:#1a56db;
}
.btn-danger {
    background:#ef4444;
    padding:6px 10px;
    font-size:14px;
}
.btn-wa { background:#25D366; }
.small-input {
    width:70px;
    display:inline-block;
}

/* ===== SEMATKAN MENU ===== */
.toggle-btn {
    background:#f1f5ff;
    color:#1a56db;
    border:1px dashed #1a56db;
    font-size:15px;
}
.manual-box {
    display:none;
    margin-top:10px;
}
</style>
</head>

<body>

<div class="header">
    <img src="logo.png" alt="Logo">
    <h2>Kasir Alkes PKY</h2>
</div>

<!-- ===== INPUT BARANG DATABASE ===== -->
<div class="card">
    <input id="search" placeholder="Cari nama / barcode..." oninput="cariBarang()">

    <select id="listBarang"></select>

    <input id="qty" type="number" value="1" min="1">

    <button class="btn" onclick="tambah()">Tambah ke Keranjang</button>

    <!-- ===== TOGGLE TAMBAH MANUAL ===== -->
    <button class="btn toggle-btn" onclick="toggleManual()">
        âž• Tambah Barang Manual
    </button>

    <div id="manualBox" class="manual-box">
        <input id="manualNama" placeholder="Nama Barang">
        <input id="manualHarga" type="number" placeholder="Harga">
        <input id="manualQty" type="number" value="1" min="1">
        <button class="btn" onclick="tambahManual()">Simpan Barang Manual</button>
    </div>
</div>

<!-- ===== KERANJANG ===== -->
<div class="card">
    <h3>Keranjang</h3>
    <table id="keranjangList"></table>

    <input id="diskon" type="number" placeholder="Diskon">
    <select id="diskonTipe">
        <option value="rp">Diskon Rupiah</option>
        <option value="persen">Diskon Persen (%)</option>
    </select>

    <div class="total-box">
        Total: <span id="total">Rp 0</span>
    </div>

    <button class="btn" onclick="cetakStruk()">ðŸ§¾ Cetak Struk</button>
    <button class="btn btn-wa" onclick="kirimWA()">Kirim WhatsApp</button>
</div>

<!-- ===== SCRIPT ===== -->
<script src="excel.js"></script>

<script>
let database = [];
let keranjang = [];

/* === LOAD EXCEL === */
readExcel("data.xlsx", data => {
    database = data;
    renderSelect();
});

/* === RENDER SELECT === */
function renderSelect() {
    listBarang.innerHTML = database.map(b =>
        `<option value="${b.nama}" data-harga="${b.harga}">
        ${b.nama} - Rp ${b.harga.toLocaleString()}
        </option>`
    ).join("");
}

/* === SEARCH === */
function cariBarang() {
    let q = search.value.toLowerCase();
    listBarang.innerHTML = database.filter(b =>
        b.nama.toLowerCase().includes(q) ||
        (b.kode && b.kode.toString().includes(q))
    ).map(b =>
        `<option value="${b.nama}" data-harga="${b.harga}">
        ${b.nama} - Rp ${b.harga.toLocaleString()}
        </option>`
    ).join("");
}

/* === TAMBAH DATABASE === */
function tambah() {
    let opt = listBarang.selectedOptions[0];
    keranjang.push({
        nama: opt.value,
        harga: Number(opt.dataset.harga),
        qty: Number(qty.value)
    });
    renderKeranjang();
}

/* === TAMBAH MANUAL === */
function tambahManual(){
    if(!manualNama.value || !manualHarga.value)
        return alert("Lengkapi data barang manual");

    keranjang.push({
        nama: manualNama.value,
        harga: Number(manualHarga.value),
        qty: Number(manualQty.value)
    });

    manualNama.value="";
    manualHarga.value="";
    manualQty.value=1;
    renderKeranjang();
}

/* === TOGGLE MANUAL === */
function toggleManual(){
    manualBox.style.display =
        manualBox.style.display==="none" || !manualBox.style.display
        ? "block" : "none";
}

/* === KERANJANG === */
function renderKeranjang() {
    let total = 0;
    keranjangList.innerHTML = keranjang.map((b,i)=>{
        let sub = b.qty * b.harga;
        total += sub;
        return `
        <tr>
            <td>
                <strong>${b.nama}</strong><br>
                Qty <input class="small-input" type="number" value="${b.qty}"
                    onchange="ubahQty(${i},this.value)">
                Harga <input class="small-input" type="number" value="${b.harga}"
                    onchange="ubahHarga(${i},this.value)">
                <button class="btn-danger" onclick="hapusItem(${i})">X</button>
            </td>
            <td class="right">Rp ${sub.toLocaleString()}</td>
        </tr>`;
    }).join("");

    let potongan = hitungDiskon(total);
    document.getElementById("total").innerText =
        "Rp " + (total - potongan).toLocaleString();
}

/* === EDIT === */
function ubahQty(i,v){ keranjang[i].qty = Number(v); renderKeranjang(); }
function ubahHarga(i,v){ keranjang[i].harga = Number(v); renderKeranjang(); }
function hapusItem(i){
    if(confirm("Hapus item?")){
        keranjang.splice(i,1);
        renderKeranjang();
    }
}

/* === DISKON === */
diskon.oninput = diskonTipe.onchange = renderKeranjang;

function hitungDiskon(total){
    let d = Number(diskon.value || 0);
    return diskonTipe.value === "persen" ? total*d/100 : d;
}

/* === CETAK === */
function cetakStruk(){
    let subtotal = keranjang.reduce((s,b)=>s+b.qty*b.harga,0);
    let pot = hitungDiskon(subtotal);
    localStorage.setItem("strukData", JSON.stringify({
        items:keranjang,
        subtotal,
        diskon:pot,
        total:subtotal-pot
    }));
    location.href="struk.html";
}

/* === WHATSAPP === */
function kirimWA(){
    if(!keranjang.length) return alert("Keranjang kosong");
    let t="", total=0;
    keranjang.forEach(b=>{
        let s=b.qty*b.harga; total+=s;
        t+=`${b.qty}x ${b.nama} = Rp ${s.toLocaleString()}\n`;
    });
    let pot=hitungDiskon(total);
    t+=`\nSubtotal : Rp ${total.toLocaleString()}`;
    t+=`\nDiskon : Rp ${pot.toLocaleString()}`;
    t+=`\nTOTAL : Rp ${(total-pot).toLocaleString()}`;
    open(`https://wa.me/?text=${encodeURIComponent(t)}`);
}

/* === SW === */
if("serviceWorker" in navigator){
    navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
