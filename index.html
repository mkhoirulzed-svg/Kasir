<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Kasir Alkes</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
    body { font-family: Arial, sans-serif; padding: 15px; }
    .box { border: 1px solid #ccc; padding: 10px; margin-bottom: 15px; border-radius: 5px; }
    button { padding: 8px 12px; margin-top: 10px; cursor: pointer; }
    #keranjangTable td { padding: 4px 6px; }
</style>
</head>

<body>

<h2>üõí Kasir Alkes ‚Äì Realtime Stok</h2>

<script>
const API_URL = "PASTE_URL_WEBAPP_MU_DI_SINI"; // <--- GANTI INI

let database = [];
let keranjang = [];

// =======================================================
// 1. LOAD DATA dari Google Sheets (GET)
// =======================================================
async function loadData() {
    try {
        const res = await fetch(API_URL + "?action=getItems");
        database = await res.json();
        renderSelect();
    } catch (e) {
        alert("Gagal memuat data dari server.");
        console.log(e);
    }
}

// =======================================================
// 2. Tampilkan pilihan produk + stok realtime
// =======================================================
function renderSelect() {
    const select = document.getElementById("produk");
    select.innerHTML = "";

    database.forEach(item => {
        const opt = document.createElement("option");
        opt.value = item.kode;
        opt.textContent = `${item.nama} ‚Äî Rp${item.harga} ‚Äî Stok: ${item.stok}`;
        select.appendChild(opt);
    });
}

// =======================================================
// 3. Tambahkan ke keranjang
// =======================================================
function tambahKeranjang() {
    const kode = document.getElementById("produk").value;
    const qty = parseInt(document.getElementById("qty").value);

    if (!kode || qty <= 0) {
        alert("Isi jumlah dengan benar.");
        return;
    }

    const item = database.find(i => i.kode === kode);
    if (!item) return;

    if (qty > item.stok) {
        alert("Stok tidak cukup.");
        return;
    }

    keranjang.push({
        nama: item.nama,
        kode: item.kode,
        harga: item.harga,
        qty: qty,
        total: qty * item.harga
    });

    renderKeranjang();
}

// =======================================================
// 4. Render tabel keranjang
// =======================================================
function renderKeranjang() {
    const tbody = document.getElementById("keranjangBody");
    tbody.innerHTML = "";

    keranjang.forEach((item, i) => {
        tbody.innerHTML += `
            <tr>
                <td>${item.nama}</td>
                <td>${item.qty}</td>
                <td>Rp${item.harga}</td>
                <td>Rp${item.total}</td>
                <td><button onclick="hapus(${i})">‚ùå</button></td>
            </tr>`;
    });
}

function hapus(i) {
    keranjang.splice(i, 1);
    renderKeranjang();
}

// =======================================================
// 5. Print Struk
// =======================================================
function printStruk() {
    let struk = "=== STRUK PEMBELIAN ===\n\n";

    let grand = 0;
    keranjang.forEach(i => {
        struk += `${i.nama} x ${i.qty} = Rp${i.total}\n`;
        grand += i.total;
    });

    struk += `\nTOTAL: Rp${grand}\n`;
    struk += "\nTerima kasih telah berbelanja.";

    let w = window.open("", "_blank");
    w.document.write(`<pre>${struk}</pre>`);
    w.print();
    w.close();
}

// =======================================================
// 6. Checkout ‚Üí update stok di Google Sheets
// =======================================================
async function checkout() {
    if (keranjang.length === 0) {
        alert("Keranjang kosong.");
        return;
    }

    try {
        await fetch(API_URL, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                action: "sell",
                data: keranjang.map(it => ({
                    nama: it.nama,
                    kode: it.kode,
                    qty: it.qty
                }))
            })
        });

        printStruk();

        keranjang = [];
        renderKeranjang();
        loadData();

        alert("Transaksi berhasil disimpan.");
    } catch (e) {
        alert("Gagal checkout.");
        console.log(e);
    }
}

window.onload = loadData;
</script>

<!-- ====================== UI ====================== -->

<div class="box">
    <h3>Pilih Produk</h3>
    <select id="produk" style="width: 100%; padding: 8px;"></select>

    <input id="qty" type="number" min="1" value="1"
           style="width: 100%; padding: 8px; margin-top: 10px;">

    <button onclick="tambahKeranjang()" style="width:100%; background: #28a745; color:white;">
        ‚ûï Tambahkan
    </button>
</div>

<div class="box">
    <h3>Keranjang</h3>
    <table width="100%" border="1" style="border-collapse: collapse;">
        <thead>
            <tr><th>Item</th><th>Qty</th><th>Harga</th><th>Total</th><th></th></tr>
        </thead>
        <tbody id="keranjangBody"></tbody>
    </table>

    <button onclick="checkout()" style="width:100%; background:#007bff; color:white;">
        üí≥ Checkout
    </button>
</div>

</body>
</html>
