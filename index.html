<!DOCTYPE html>
<html lang="id">
<head>
<!-- ===== PWA & ICON ===== -->
<link rel="icon" type="image/png" href="logo.png">
<link rel="apple-touch-icon" href="logo.png">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1a56db">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kasir Alkes PKY</title>

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap">

<style>
body {
    margin:0;
    font-family:'Inter',sans-serif;
    background:#e9f2ff;
    padding:15px;
    padding-top:120px;
}
h2 { text-align:center; color:#1a56db; }

/* ===== HEADER ===== */
.app-header {
    position: fixed;
    top: 0; left: 0; right: 0;
    background: #ffffff;
    display: flex;
    flex-direction: column;
    padding: 10px 12px 0;
    border-bottom: 1px solid #e5e7eb;
    z-index: 1000;
}
.app-brand {
    display:flex;
    align-items:center;
    gap:10px;
    font-weight:600;
    color:#1a56db;
    margin-bottom:6px;
}
.app-brand img { height:32px; }
.app-menu { display:flex; }
.app-menu a {
    flex:1;
    padding:10px 0;
    text-align:center;
    text-decoration:none;
    color:#64748b;
    font-size:14px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:4px;
}
.app-menu a.active {
    color:#1a56db;
    border-bottom:3px solid #1a56db;
}

/* ===== KASIR ===== */
.card {
    background:#fff;
    padding:15px;
    border-radius:12px;
    box-shadow:0 3px 10px rgba(0,0,0,.1);
    margin-bottom:20px;
}
input,select {
    width:100%;
    padding:12px;
    margin:6px 0;
    border-radius:8px;
    border:1px solid #ccc;
    font-size:16px;
}
.btn {
    width:100%;
    padding:14px;
    border:none;
    border-radius:8px;
    font-size:18px;
    font-weight:bold;
    margin-top:10px;
    background:#1a56db;
    color:#fff;
}
table { width:100%; font-size:15px; }
td { padding:6px 0; }
.right { text-align:right; }
.total-box {
    text-align:right;
    font-size:20px;
    font-weight:bold;
    color:#1a56db;
}
.btn-danger {
    background:#ef4444;
    padding:6px 10px;
    font-size:14px;
}
.btn-wa { background:#25D366; }
.small-input {
    width:70px;
    display:inline-block;
}
.toggle-btn {
    background:#f1f5ff;
    color:#1a56db;
    border:1px dashed #1a56db;
}
.manual-box { display:none; margin-top:10px; }
</style>
</head>

<body>

<!-- ===== HEADER ===== -->
<div class="app-header">
  <div class="app-brand">
    <img src="logo.png">
    <span>Kasir Alkes PKY</span>
  </div>
</div>

<!-- ===== INPUT BARANG ===== -->
<div class="card">
    <input id="search" placeholder="Cari nama barang..." oninput="cariBarang()">
    <select id="listBarang"></select>
    <input id="qty" type="number" value="1" min="1">
    <button class="btn" onclick="tambah()">Tambah ke Keranjang</button>

    <button class="btn toggle-btn" onclick="toggleManual()">âž• Tambah Barang Manual</button>

    <div id="manualBox" class="manual-box">
        <input id="manualNama" placeholder="Nama Barang">
        <input id="manualHarga" type="number" placeholder="Harga">
        <input id="manualQty" type="number" value="1" min="1">
        <button class="btn" onclick="tambahManual()">Simpan Barang Manual</button>
    </div>
</div>

<!-- ===== KERANJANG ===== -->
<div class="card">
    <h3>Keranjang</h3>
    <table id="keranjangList"></table>

    <input id="diskon" type="number" placeholder="Diskon">
    <select id="diskonTipe">
        <option value="rp">Diskon Rupiah</option>
        <option value="persen">Diskon Persen (%)</option>
    </select>

    <div class="total-box">
        Total: <span id="total">Rp 0</span>
    </div>

    <button class="btn" onclick="cetakStruk()">ðŸ§¾ Cetak Struk</button>
    <button class="btn btn-wa" onclick="kirimWA()">Kirim WhatsApp</button>
</div>

<!-- ===== SCRIPT ===== -->
<script>
let database = [];
let keranjang = [];

/* ðŸ”— API SPREADSHEET */
const API_BARANG =
  "https://script.google.com/macros/s/XXXXX/exec?action=barang_kasir";

/* LOAD DATA BARANG */
fetch(API_BARANG)
  .then(res => res.json())
  .then(data => {
    database = data;
    renderSelect();
  })
  .catch(() => alert("Gagal load data barang"));

function renderSelect(){
  listBarang.innerHTML = database.map(b =>
    `<option value="${b.nama}" data-harga="${b.harga}">
      ${b.nama} - Rp ${b.harga.toLocaleString()}
    </option>`
  ).join("");
}

function cariBarang(){
  let q = search.value.toLowerCase();
  listBarang.innerHTML = database
    .filter(b => b.nama.toLowerCase().includes(q))
    .map(b =>
      `<option value="${b.nama}" data-harga="${b.harga}">
        ${b.nama} - Rp ${b.harga.toLocaleString()}
      </option>`
    ).join("");
}

function tambah(){
  let opt = listBarang.selectedOptions[0];
  keranjang.push({
    nama: opt.value,
    harga: Number(opt.dataset.harga),
    qty: Number(qty.value)
  });
  renderKeranjang();
}

function tambahManual(){
  if(!manualNama.value || !manualHarga.value)
    return alert("Lengkapi data barang");

  keranjang.push({
    nama: manualNama.value,
    harga: Number(manualHarga.value),
    qty: Number(manualQty.value)
  });
  manualNama.value=""; manualHarga.value=""; manualQty.value=1;
  renderKeranjang();
}

function toggleManual(){
  manualBox.style.display =
    manualBox.style.display==="block" ? "none" : "block";
}

function renderKeranjang(){
  let total=0;
  keranjangList.innerHTML = keranjang.map((b,i)=>{
    let sub=b.qty*b.harga; total+=sub;
    return `<tr>
      <td><strong>${b.nama}</strong><br>
      Qty <input class="small-input" type="number" value="${b.qty}"
        onchange="ubahQty(${i},this.value)">
      </td>
      <td class="right">Rp ${sub.toLocaleString()}
      <button class="btn-danger" onclick="hapusItem(${i})">X</button>
      </td>
    </tr>`;
  }).join("");

  let pot = hitungDiskon(total);
  totalSpan.textContent = "Rp " + (total-pot).toLocaleString();
}

function ubahQty(i,v){ keranjang[i].qty=Number(v); renderKeranjang(); }
function hapusItem(i){
  if(confirm("Hapus item?")){
    keranjang.splice(i,1);
    renderKeranjang();
  }
}

diskon.oninput = diskonTipe.onchange = renderKeranjang;

function hitungDiskon(t){
  let d=Number(diskon.value||0);
  return diskonTipe.value==="persen" ? t*d/100 : d;
}

function cetakStruk(){
  localStorage.setItem("strukData", JSON.stringify(keranjang));
  alert("Struk disimpan");
}

function kirimWA(){
  if(!keranjang.length) return alert("Keranjang kosong");
  let t="",total=0;
  keranjang.forEach(b=>{
    let s=b.qty*b.harga; total+=s;
    t+=`${b.qty}x ${b.nama} = Rp ${s.toLocaleString()}\n`;
  });
  open(`https://wa.me/?text=${encodeURIComponent(t)}`);
}
</script>

</body>
</html>
