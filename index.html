<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kasir - Google Sheets</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap">
<style>
  body { font-family: 'Inter', sans-serif; margin:16px; background:#eef6ff }
  .card { background:white; padding:14px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.06); margin-bottom:12px }
  input, select { width:100%; padding:10px; margin:8px 0; border-radius:8px; border:1px solid #ccc }
  .btn { background:#1a56db; color:white; padding:12px; border:none; border-radius:8px; cursor:pointer; width:100% }
  table { width:100%; border-collapse:collapse; margin-top:10px }
  td, th { padding:8px; border-bottom:1px solid #eee }
  .right { text-align:right }
</style>
</head>
<body>

<h2>Kasir (Sheet: Stok_Toko_Alkes)</h2>

<div class="card">
  <input id="search" placeholder="Cari nama / kode..." oninput="filterList()" />
  <select id="listBarang" size="6" style="height:130px"></select>
  <div style="display:flex; gap:8px; margin-top:8px">
    <input id="qty" type="number" value="1" min="1" style="flex:1" />
    <button class="btn" onclick="tambah()">Tambah</button>
  </div>
  <div style="margin-top:6px; font-size:13px; color:#555">Stok diperbarui di Google Sheets saat <strong>Cetak Struk</strong>.</div>
</div>

<div class="card">
  <h3>Keranjang</h3>
  <table><thead><tr><th>Nama</th><th class="right">Qty</th><th class="right">Subtotal</th></tr></thead>
    <tbody id="keranjangList"></tbody>
  </table>
  <div style="margin-top:10px; font-weight:bold" class="right">Total: Rp <span id="total">0</span></div>
  <div style="margin-top:10px">
    <button class="btn" onclick="cetakStruk()">Simpan Transaksi & Update Stok</button>
  </div>
</div>

<div class="card" id="log" style="display:none"></div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwLLyCMH-YFQnYYI9-RMcgc5tvdf2Smw6uxoWJFRP_7VYPDLq8dhkLtlGyHsQWuv4t6Zg/exec";

// in-memory DB dari Sheets
let database = []; // setiap object: {nama, harga, kode, stok}
let keranjang = [];

// load items on startup
window.addEventListener("load", loadItems);

async function loadItems() {
  try {
    const res = await fetch(`${WEB_APP_URL}?action=getItems`);
    const items = await res.json();
    database = items.map(it => ({
      nama: (it.nama || "").toString(),
      harga: Number(it.harga || 0),
      kode: it.kode !== undefined ? it.kode.toString() : "",
      stok: Number(it.stok || 0)
    }));
    renderList(database);
  } catch (err) {
    alert("Gagal memuat data dari Sheets. Cek Web App URL & permissions.");
    console.error(err);
  }
}

function renderList(items) {
  const sel = document.getElementById("listBarang");
  sel.innerHTML = "";
  items.forEach((it, idx) => {
    const opt = document.createElement("option");
    opt.value = idx; // gunakan index untuk akses cepat
    opt.text = `${it.nama} — Rp ${format(it.harga)} (Stok: ${it.stok}) ${it.kode ? " | " + it.kode : ""}`;
    sel.appendChild(opt);
  });
}

function filterList() {
  const q = document.getElementById("search").value.toLowerCase();
  const filtered = database.filter(it =>
    (it.nama || "").toLowerCase().includes(q) ||
    (it.kode || "").toLowerCase().includes(q)
  );
  renderList(filtered);
}

// tambah ke keranjang (cek stok sekarang)
function tambah() {
  const sel = document.getElementById("listBarang");
  if (!sel.value && sel.value !== "0") { alert("Pilih barang dulu"); return; }
  const idx = Number(sel.value);
  const item = database[idx];
  const qty = Number(document.getElementById("qty").value) || 1;

  if (qty <= 0) { alert("Qty minimal 1"); return; }
  if (item.stok <= 0) { alert("Stok kosong untuk barang ini"); return; }
  if (qty > item.stok) {
    if (!confirm(`Qty melebihi stok (${item.stok}). Tambah tetap?`)) return;
  }

  // jika barang sudah ada di keranjang, tambahkan qty
  const exist = keranjang.find(k => k.nama === item.nama && k.kode === item.kode);
  if (exist) {
    exist.qty += qty;
  } else {
    keranjang.push({ nama: item.nama, kode: item.kode, harga: item.harga, qty });
  }
  renderKeranjang();
}

function renderKeranjang() {
  const tbody = document.getElementById("keranjangList");
  tbody.innerHTML = "";
  let total = 0;
  keranjang.forEach((k, i) => {
    const sub = k.harga * k.qty;
    total += sub;
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${k.nama}</td><td class="right">${k.qty}</td><td class="right">Rp ${format(sub)}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById("total").innerText = format(total);
}

// cetakStruk -> kirim transaksi ke Apps Script (sell)
async function cetakStruk() {
  if (keranjang.length === 0) { alert("Keranjang kosong"); return; }

  // persiapkan payload: array {nama, kode, qty}
  const payloadData = keranjang.map(it => ({ nama: it.nama, kode: it.kode, qty: it.qty }));

  // kirim ke web app
  try {
    const resp = await fetch(WEB_APP_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "sell", data: payloadData })
    });
    const result = await resp.json();
    console.log("result", result);

    if (result.status === "success") {
      // periksa apakah ada kegagalan di report
      const failed = (result.report && result.report.failed && result.report.failed.length) ? result.report.failed : [];
      if (failed.length > 0) {
        let msg = "Beberapa item gagal diupdate:\n";
        failed.forEach(f => msg += `${f.nama} (req ${f.requested}) — ${f.reason}\n`);
        alert(msg);
        // reload data agar stok akurat
        await loadItems();
        return;
      }

      // success semua -> simpan struk di localStorage dan pindah ke struk.html
      localStorage.setItem("strukData", JSON.stringify(keranjang));
      alert("Transaksi sukses. Stok telah diperbarui di Google Sheets.");
      // Clear keranjang & reload items
      keranjang = [];
      renderKeranjang();
      await loadItems();

      // pindah ke halaman struk bila ada
      if (location.href.indexOf("struk.html") === -1) {
        // jika punya halaman struk.html, uncomment baris berikut:
        // location.href = "struk.html";
      }
    } else {
      alert("Gagal memperbarui stok: " + (result.message || "unknown"));
    }
  } catch (err) {
    console.error(err);
    alert("Kesalahan jaringan saat mengupdate stok. Cek console.");
  }
}

function format(n) {
  return n.toLocaleString("id-ID");
}
</script>

</body>
</html>
